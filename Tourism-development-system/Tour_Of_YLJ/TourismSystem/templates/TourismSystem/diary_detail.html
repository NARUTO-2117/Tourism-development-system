{% extends "TourismSystem/base.html" %}
{% block content %}
<div class="diary-detail-container">
    <h2>{{ diary.title }}</h2>
    <div class="diary-meta">
        <span>作者：{{ diary.author.username }}</span> |
        <span>景点：<a href="{% url 'attraction_detail' diary.attraction.id %}">{{ diary.attraction.name }}</a></span> |
        <span>评分：
            {% for i in "12345" %}
                {% if i|add:'0' <= diary.rating|stringformat:"d" %}
                    <span style="color:#FFD700">&#9733;</span>
                {% else %}
                    <span style="color:#ccc">&#9733;</span>
                {% endif %}
            {% endfor %}
            ({{ diary.rating }}/5)
        </span> |
        <span>热度：{{ diary.popularity }}</span> |
        <span>创建时间：{{ diary.created_at|date:"Y-m-d H:i" }}</span>
    </div>
    <div class="diary-image">
        {% if diary.image %}
            <img src="{{ diary.image.url }}" alt="日记图片" style="max-width:400px;max-height:300px;">
        {% endif %}
    </div>
    <div class="diary-content" style="margin: 20px 0;">
        <p>{{ diary.content|linebreaksbr }}</p>
    </div>
    <div class="diary-actions">
        <form method="post" action="/TourismSystem/diary/{{ diary.id }}/like/" class="like-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-primary like-btn {% if request.user in diary.likes.all %}liked{% endif %}">
                <i class="fas fa-heart"></i> 点赞 <span class="like-count">({{ diary.likes.count }})</span>
            </button>
        </form>
    </div>
    <hr>
    <div class="diary-comments">
        <h4>评论 ({{ diary.comments.count }})</h4>
        {% for comment in diary.comments.all %}
            <div class="comment-item" style="margin-bottom:10px;">
                <b>{{ comment.author.username }}</b>：{{ comment.content }}
                <span style="color:#888;font-size:0.9em;">({{ comment.created_at|date:"Y-m-d H:i" }})</span>
            </div>
        {% empty %}
            <p>暂无评论，快来抢沙发！</p>
        {% endfor %}
        <form method="post" action="/TourismSystem/diary/{{ diary.id }}/comment/">
            {% csrf_token %}
            <textarea name="content" rows="2" placeholder="写下你的评论..." required style="width:100%;margin-top:10px;"></textarea>
            <button type="submit" class="btn btn-success" style="margin-top:5px;">发表评论</button>
        </form>
    </div>
</div>

<style>
.like-btn {
    transition: all 0.3s ease;
    border: 1px solid #1765c1;
    color: #1765c1;
    background: white;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
}

.like-btn:hover {
    background: #e3f0ff;
}

.like-btn.liked {
    background: #1765c1;
    color: white;
}

.like-btn i {
    margin-right: 4px;
}

.like-count {
    font-size: 0.9em;
    opacity: 0.8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeForm = document.querySelector('.like-form');
    const likeBtn = likeForm.querySelector('.like-btn');
    const likeCount = likeForm.querySelector('.like-count');
    
    likeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.liked) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
            likeCount.textContent = `(${data.likes_count})`;
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}