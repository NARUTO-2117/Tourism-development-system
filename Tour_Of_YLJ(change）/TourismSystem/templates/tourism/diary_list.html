{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>旅游日记</h2>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'create_diary' %}" class="btn btn-primary">写日记</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <form method="get" class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="search">搜索</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       value="{{ search_query }}" placeholder="输入关键词">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="location">景点筛选</label>
                                <select class="form-control" id="location" name="location">
                                    <option value="">全部景点</option>
                                    {% for spot in spots_1.objects.all %}
                                    <option value="{{ spot.id }}" {% if location_id == spot.id|stringformat:"s" %}selected{% endif %}>
                                        {{ spot.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="sort">排序方式</label>
                                <select class="form-control" id="sort" name="sort">
                                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>最新发布</option>
                                    <option value="views" {% if sort_by == 'views' %}selected{% endif %}>浏览量</option>
                                    <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>评分</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">筛选</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        {% for diary in diaries %}
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{% url 'diary_detail' diary.id %}" class="text-decoration-none">{{ diary.title }}</a>
                    </h5>
                    <div class="text-muted mb-2">
                        <small>
                            作者: {{ diary.author.username }} | 
                            发布时间: {{ diary.created_at|date:"Y-m-d" }}
                            {% if diary.location %}
                            | 景点: {{ diary.location.name }}
                            {% endif %}
                        </small>
                    </div>
                    <p class="card-text">{{ diary.get_decompressed_content|truncatechars:200 }}</p>
                    <div class="text-muted">
                        <small>
                            浏览量: {{ diary.views }} | 
                            评分: {{ diary.rating|floatformat:1 }} ({{ diary.total_ratings }}人评分)
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                暂无旅游日记
            </div>
        </div>
        {% endfor %}
    </div>

    {% if diaries.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if diaries.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ diaries.previous_page_number }}&search={{ search_query }}&sort={{ sort_by }}&location={{ location_id }}">
                    上一页
                </a>
            </li>
            {% endif %}

            {% for i in diaries.paginator.page_range %}
            <li class="page-item {% if diaries.number == i %}active{% endif %}">
                <a class="page-link" href="?page={{ i }}&search={{ search_query }}&sort={{ sort_by }}&location={{ location_id }}">
                    {{ i }}
                </a>
            </li>
            {% endfor %}

            {% if diaries.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ diaries.next_page_number }}&search={{ search_query }}&sort={{ sort_by }}&location={{ location_id }}">
                    下一页
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %} 