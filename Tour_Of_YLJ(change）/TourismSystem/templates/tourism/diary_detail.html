{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>{{ diary.title }}</h2>
            <div class="text-muted mb-3">
                <small>作者: {{ diary.author.username }} | 发布时间: {{ diary.created_at|date:"Y-m-d H:i" }}</small>
                {% if diary.location %}
                <small>| 景点: {{ diary.location.name }}</small>
                {% endif %}
            </div>
            <div class="card">
                <div class="card-body">
                    <div id="diary-content">{{ diary.get_decompressed_content }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5>日记信息</h5>
                    <p>浏览量: {{ diary.views }}</p>
                    <p>评分: {{ diary.rating|floatformat:1 }} ({{ diary.total_ratings }}人评分)</p>
                    
                    {% if user.is_authenticated %}
                    <div class="rating-section">
                        <h6>为日记评分</h6>
                        <div class="stars">
                            {% for i in "12345" %}
                            <span class="star" data-rating="{{ i }}" 
                                  {% if user_rating and user_rating >= i %}style="color: gold;"{% endif %}>★</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <h6>全文搜索</h6>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" placeholder="输入搜索关键词">
                            <button class="btn btn-primary" id="search-btn">搜索</button>
                        </div>
                        <div id="search-results" class="mt-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 评分功能
    const stars = document.querySelectorAll('.star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.dataset.rating;
            fetch(`/diary/{{ diary.id }}/rate/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `rating=${rating}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            });
        });
    });

    // 搜索功能
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    
    searchBtn.addEventListener('click', function() {
        const query = searchInput.value;
        if (!query) return;
        
        fetch(`/diary/{{ diary.id }}/search/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                searchResults.innerHTML = '';
                if (data.matches.length === 0) {
                    searchResults.innerHTML = '<p>未找到匹配结果</p>';
                    return;
                }
                
                data.matches.forEach(match => {
                    const div = document.createElement('div');
                    div.className = 'search-result mb-2';
                    div.innerHTML = `<small class="text-muted">...${match.context}...</small>`;
                    searchResults.appendChild(div);
                });
            });
    });
});
</script>

<style>
.star {
    cursor: pointer;
    font-size: 24px;
    color: #ccc;
}
.star:hover {
    color: gold;
}
.search-result {
    padding: 5px;
    border-bottom: 1px solid #eee;
}
</style>
{% endblock %} 